<!DOCTYPE html>
<html>
<head>
<head th:include="/thymeleaf/common/_head::head('创建合同')">
<meta charset="UTF-8">
</head>
<body>
	<div class="container">
		<!-- 对话框 -->
		<div th:replace="thymeleaf/common/_discount_dialog::dialog" ></div>
		<div class="row clearfix">
			<div class="col-md-12 column">
				<h3>创建合同</h3>
				<div class="panel panel-success">
					<div class="panel-heading">
						<h3 class="panel-title">商品列表(订单消息)</h3>
					</div>
					<div class="panel-body">
						<table class="table">
							<thead>
								<!-- <tr>
									<th>编号</th>
									<th>名称</th>
									<th>品牌</th>
									<th>型号</th>
									<th>基本参数</th>
									<th>网示单价</th>
									<th>折减金额</th>
									<th>成交单价</th>
									<th>数量</th>
									<th>合计</th>
									<th>操作</th>
								</tr> -->
								
								<th>序号</th>
								<th>名称</th>								
								<th>网示单价</th>
								<th>折减金额</th>
								<th>成交单价</th>
								<th>数量</th>
								<th>合计</th>
								<th>操作</th>
							</thead>
							<tbody>
								<tr th:each="orderItem,iterState:${orderItemList}">
									<td th:text="${iterState.count}">序号</td>
									<td th:text="${orderItem.sku_name}" th:attr="id='sku_name_'+${orderItem.id}">产品名称</td>
									<td th:text="'￥'+${orderItem.primitive_price}" th:attr="id='primitive_price_'+${orderItem.id}">网示单价</td>
									<td th:attr="id='discount_price_'+${orderItem.id}">￥0.00</td>
									<td th:text="'￥'+${orderItem.primitive_price}" th:attr="id='pay_price_'+${orderItem.id}" >成交单价</td>
									<td th:text="${orderItem.num}" th:attr="id='num_'+${orderItem.id}" >数量</td>
									<td th:text="'￥'+${orderItem.num}*${orderItem.primitive_price}" th:attr="id='amount_'+${orderItem.id}">小计</td>									
									<td><button type="button" class="btn btn-sm btn-primary" th:attr="data-bind=${orderItem.id}"  onclick="displayDiscountDialog(this);" >折减</button></td>
								</tr>								
								<tr>
									<td>总计</td>
									<td colspan="8"></td>
									<td><strong style="font-size:18px;color:red" id="sumAmount">总计</strong></td>
									<td></td>
								</tr>
								</hr>					
							</tbody>
						</table>
					</div>
					<!-- <div class="panel-footer">Panel footer</div> -->
				</div>
				<div class="panel panel-info">
					<div class="panel-heading">
						<h3 class="panel-title">合同细则</h3>
					</div>
					<div class="panel-body">
						<form class="form-horizontal" role="form">
							<div class="form-group">
								<label  class="col-sm-3 control-label">质保期</label>
								<div class="col-sm-6">
									<label for="guarantee_period_1"><input type="checkbox" name="guarantee_period"	id="guarantee_period_1" value="1" /> 原厂标准质保</label> 
									<label for="guarantee_period_2"><input type="checkbox" name="guarantee_period" id="guarantee_period_2" value="2" /> 用户特殊质保</label>
								</div>
							</div>
							
							<div class="form-group">
								<label for="delivery_time" class="col-sm-3 control-label">交货时间</label>
								<div class="col-sm-6">
									<input class="form-control" id="delivery_time" name="delivery_time" type="text" />
								</div>
							</div>
							
							<div class="form-group">
								<label for="delivery_address" class="col-sm-3 control-label">交货地址</label>
								<div class="col-sm-6">
									<input class="form-control" id="delivery_address" name="delivery_address" type="text" />
								</div>
							</div>
							
							<div class="form-group">
								<label for="transport_charge" class="col-sm-3 control-label">运输方式及费用负担</label>
								<div class="col-sm-6">
									<input class="form-control" id="transport_charge" name="transport_charge" type="text" />
								</div>
							</div>
							

							<!-- 付款方式1 -->
							<div class="form-group">
								<label for="pay_type_1" class="col-sm-3 control-label">付款方式1</label>
								<div class="col-sm-1">
									<input class="form-control" id="pay_type_1" name="pay_type"	type="checkbox" value="1" />
								</div>
							</div>
							
							<div class="form-group">
								<label for="payment_percent_signed" class="col-sm-offset-2 col-sm-3 control-label">合同签定后甲方支付合同百分比</label>
								<div class="col-sm-4">
									<input class="form-control" id="payment_percent_signed" name="payment_percent_signed"
										type="text" />
								</div>
							</div>
							<div class="form-group">
								<label for="payment_amount_signed" class="col-sm-offset-2 col-sm-3 control-label">合同签定后甲方支付金额</label>
								<div class="col-sm-4">
									<input class="form-control" id="payment_amount_signed" name="payment_amount_signed"
										type="text" />
								</div>
							</div>
							
							<div class="form-group">
								<label for="payment_percent_delivery" class="col-sm-offset-2 col-sm-3 control-label">发货前甲方支付合同百分比</label>
								<div class="col-sm-4">
									<input class="form-control" id="payment_percent_delivery" name="payment_percent_delivery"
										type="text" />
								</div>
							</div>
							
							<div class="form-group">
								<label for="payment_amount_delivery" class="col-sm-offset-2 col-sm-3 control-label">发货前甲方支付合同金额</label>
								<div class="col-sm-4">
									<input class="form-control" id="payment_amount_delivery" name="payment_amount_delivery"
										type="text" />
								</div>
							</div>
							
							<!-- 付款方式2 -->
							<div class="form-group">
								<label for="pay_type_2" class="col-sm-3 control-label">付款方式2</label>
								<div class="col-sm-1">
									<input class="form-control" id="pay_type_2" name="pay_type" type="checkbox" value="2"/>
								</div>
							</div>
							
							<div class="form-group">
								<label for="days_signed" class="col-sm-offset-2 col-sm-3 control-label">签定后多少日付全部货款</label>
								<div class="col-sm-4">
									<input class="form-control" id="days_signed" name="days_signed"
										type="text" />
								</div>
							</div>
							
							<!-- 签定后于日期前付全部货款 -->
							<div class="form-group">
								<label for="date_signed" class="col-sm-offset-2 col-sm-3 control-label">签定后于日期前付全部货款</label>
								<div class="col-sm-4">
									<input class="form-control" id="date_signed" name="date_signed"
										type="text" />
								</div>
							</div>
							
							<!-- 欠款资金占用费率 -->
							<div class="form-group">
								<label for="fee_rate" class="col-sm-offset-2 col-sm-3 control-label">欠款延期资金日占用费率</label>
								<div class="col-sm-4">
									<input class="form-control" id="fee_rate" name="fee_rate"
										type="text" />
								</div>
							</div>

							<div class="form-group">
								<label for="voucher" class="col-sm-3 control-label">全款到帐后乙方开据</label>
								<div class="col-sm-6">
									<input class="form-control" id="voucher" name="voucher" type="text" />
								</div>
							</div>

							<!-- <div class="form-group">
								<div class="col-sm-offset-2 col-sm-10">
									<button type="submit" class="btn btn-default">Sign in</button>
								</div>
							</div> -->
						</form>


					</div>
					<!-- <div class="panel-footer">Panel footer</div> -->
				</div>
				<div class="row clearfix">
					<div class="col-md-12 column">
						<button type="button" class="btn btn-primary btn-create"  style="float:right;margin-right:50px" >合同确认</button>
						<a  class="btn btn-primary btn-preview" style="float:right;margin-right:10px" target="_blank">合同预览</a>
					</div>
				</div>
				<br>
				
			</div>
		</div>
	</div>
	
	
	<!-- 获取用户已经选商品列表  -->
	<script th:inline="javascript"> 
		/*<![CDATA[*/  
     
		var g_orderItemList = [[${orderItemList}]];  //订单中商品行项目
		var g_contractAttrList=[[${contractAttrList}]];  //合同属性列表
		console.log("订单中商品数量:"+g_orderItemList.length);
		
     
		/*]]>*/  
	</script>  

	<script>
		
		//===============变量定义=================
		var g_orderItemId=0;
		
		/* 设置orderItemId */
		function setOrderItemId(orderItemId){
			g_orderItemId=orderItemId;
		}
		
		function getOrderItemId(){
			return g_orderItemId;
		}
		
		function getContractAttrList(){
			return g_contractAttrList;
		}
		
		
		//==================对话框通用部分=START=================
		/*
			显示增加用户地址对话框
		 */
		function showDialog() {
			$('#modal-container-273078').modal({
				backdrop : 'static',
				keyboard : false
			});
		}
		
		/* close dialog */
		function closeDialog() {
			$("#modal-container-273078").modal("hide");
		}
		
		/* set dialog's title  */
		function setDialogTitle(title){
			$("#myModalLabel").text(title);
		}
		
		/*  reset dialog  */
		function resetDialog(){
			$("#dialog-form")[0].reset();
		}
		
		
		//===============合同条目================
		
		/* 获取合同行项目列表 */
		function getOrderItemList(){
			return g_orderItemList;
		}	
			
			
			
		/*
			显示折减对话框		
		*/
		function displayDiscountDialog(e){
			var orderItemId=$(e).attr("data-bind");  //get orderItem'id
			setOrderItemId(orderItemId);
			
			var sku_name=$("#sku_name_"+orderItemId).html();  //get sku_name and set dialog's title
			setDialogTitle("折减金额("+sku_name+")");
			
			resetDialog();
			showDialog();
		}	
			
		/*
			初始化订单条目中的折减字段为0
		*/	
		function initOrderItemDiscount(){
			var orderItemList=getOrderItemList();
			for(var i=0;i<orderItemList.length;i++){
				orderItemList[i].discount_price=0;
				orderItemList[i].pay_price=orderItemList[i].primitive_price;
				orderItemList[i].pay_price_total=orderItemList[i].primitive_price*orderItemList[i].num;
			}
		}
		
		/*
			计算订单条目小计
			params:
				id:order item id
				discount:折减金额
		*/
		function calcAmount(id,discount){
			var orderItemList=getOrderItemList();		
			var index=-1;
			for(var i=0;i<orderItemList.length;i++){
				if (orderItemList[i].id==id){
					index=i;
					break;
				}
			}
			orderItemList[index].discount_price=discount;
			orderItemList[index].pay_price=orderItemList[index].primitive_price-discount;
			orderItemList[index].pay_price_total=orderItemList[index].pay_price*orderItemList[index].num;
		}
		
		
		/*
			更新 (UI)
			params:
				id:order item id
		*/
		function displayOrderTtem(id){
			var orderItemList=getOrderItemList();		
			var index=-1;
			for(var i=0;i<orderItemList.length;i++){
				if (orderItemList[i].id==id){
					index=i;
					break;
				}
			}		
					
			$("#"+"discount_price_"+id).html('￥'+orderItemList[index].discount_price.toFixed(2));  //折减
			$("#"+"pay_price_"+id).html('￥'+orderItemList[index].pay_price.toFixed(2));  //成交价格
			$("#"+"amount_"+id).html('￥'+(orderItemList[index].pay_price*orderItemList[index].num).toFixed(2));  //小计
			
		}
		
		/*
			计算所有订单条目合计
		*/
		function calcSumAmount(){
			var orderItemList=getOrderItemList();
			var sumAmount=0.00;
			for(var i=0;i<orderItemList.length;i++){
				sumAmount=sumAmount+orderItemList[i].pay_price*orderItemList[i].num;
			}
			return sumAmount;			
		}
		
		/*
			显示总计
		*/
		function displaySumAmount(sumAmount){
			$("#sumAmount").text('￥'+sumAmount.toFixed(2));
		}
		
		//===============合同属性==================
		
		/*
			return:返回付款类型
		*/
		function getPayType(){
			var val=0;
			$("input[name='pay_type']").each(function(index,elem){
				if(this.checked){
					val=$(this).val();
					return false;
				}
			});
			return val;
		}
		
		/*
			return:返回质保期
			
		*/
		function getGuaranteePeriod(){
			var val=0;
			$("input[name='guarantee_period']").each(function(index,elem){
				if ($(this).attr("checked")) { 
					val=$(this).val();
					return false;
				}
			});
			return val;
		}
		
		/*
			初始化合同属性
		*/
		function initContractAttr(){
			$("input[name='guarantee_period']").eq(0).attr("checked",true);
			$("input[name='pay_type']").eq(0).attr("checked",true);
		}
		
		/* 收集合同属性 */
		function getContractAttrValue(contractAttrList){
			
			/* 	guarantee_period
				delivery_time
				delivery_address
				transport_charge
				payment_percent_signed
				payment_amount_signed
				payment_percent_delivery
				payment_amount_delivery
				days_signed
				date_signed
				fee_rate
				voucher
				pay_type */
			
			
			contractAttrList.forEach(function(item, index){
				if(item.attrName=='guarantee_period'){
					item.attrvalue=getGuaranteePeriod();
				}
				else if(item.attrName=='pay_type'){
					item.attrValue=getPayType();
				}
				else{
					item.attrValue=$("#"+item.attrName).val();
				}
			});
			
			return contractAttrList;
		}
		
		/* 合同预览 */
		function contractPreview(){
			var url = BASE_CONTEXT_PATH + "/back/contract/preview"; // 需要提交的 url
			
			var contractAttrList=getContractAttrList();  //合同属性列表
			var contractAttrValList=getContractAttrValue(contractAttrList);  //合同属性值
			
			var orderItemList=getOrderItemList();    //订单列表行
			
			var form = document.createElement("form");  //生成表单
			form.id="test";
			form.name="test";
			form.target="_blank";
			document.body.appendChild(form);
			
			//请求参数
			var attrVals = generateHideElement("contractAttrVals", JSON.stringify(contractAttrValList)), 
				orderItems = generateHideElement("orderItems", JSON.stringify(orderItemList)); 
			form.appendChild(attrVals);  //合同属性列表
			form.appendChild(orderItems);  //订单列表行

			//发送请求
			form.method = "post";
			form.action = url;
			form.submit();
		}
		
		
		/* 合同确认 */
		function contractCreate(){
			var url = BASE_CONTEXT_PATH + "/back/contract/create"; // 需要提交的 url
			
			var contractAttrList=getContractAttrList();  //合同属性列表
			var contractAttrValList=getContractAttrValue(contractAttrList);  //合同属性值
			
			var orderItemList=getOrderItemList();    //订单列表行
			
			var form = document.createElement("form");  //生成表单
			form.id="test";
			form.name="test";
			form.target="_blank";
			document.body.appendChild(form);
			
			//请求参数
			var attrVals = generateHideElement("contractAttrVals", JSON.stringify(contractAttrValList)), 
				orderItems = generateHideElement("orderItems", JSON.stringify(orderItemList)); 
			form.appendChild(attrVals);  //合同属性列表
			form.appendChild(orderItems);  //订单列表行

			//发送请求
			form.method = "post";
			form.action = url;
			form.submit();
			
		}
		
		
		
		//========================================
		/*
			生成隐藏表单域函数
			params:
				name:input's name
				value:inptu's value
		 */
		var generateHideElement = function(name, value) {
			var tempInput = document.createElement("input");
			tempInput.type = "hidden";
			tempInput.name = name;
			tempInput.value = value;
			return tempInput;
		}
		
		
		
		
		//==================页面-READY-初始化======================
		$(function(){
			
			initOrderItemDiscount();
			displaySumAmount(calcSumAmount());
			initContractAttr();  //初始化合同属性
			
			
			/**
				折减对话框【确定】按钮-click处理
			*/
			$("#btnConfirm").on('click', function(e){
				closeDialog();
				var discountStr=$("#discount").val();
				var discount=parseInt(discountStr,10);
				if (isNaN(discount)){
					util.message("所输入的不是数字！");
				}
				else{
					calcAmount(getOrderItemId(),discount);
					displayOrderTtem(getOrderItemId());
					displaySumAmount(calcSumAmount());
				}
				
			});
			
			/*	质保期 checkbox  click处理	*/
			$("input[name='guarantee_period']").on('click', function(e){
				
				$("input[name='guarantee_period']").each(function(index,val){
					(this).checked=false;
				});
				
				this.checked=true;
				
			});
			
			/* 收款方式 checkbox click处理 */
			$("input[name='pay_type']").on('click', function(e){
				
				$("input[name='pay_type']").each(function(index,val){
					(this).checked=false;
				});
				
				this.checked=true;
				
			});
			
			
			/* 【合同预览】 按钮 click process */
			$(".btn-preview").on('click', function(e){
				//alert("质保期："+getGuaranteePeriod());
				//alert("付款类型:"+getPayType());
				contractPreview();
				
			});
			
			/* 【合同确认】 按钮 click process */
			$(".btn-create").on('click', function(e){
				contractCreate();
			});
			
			
			
			
			
		});
	
	</script>
	
</body>
</html>